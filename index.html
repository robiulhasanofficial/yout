<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>বুকশপ | প্রিমিয়াম বইয়ের দোকান</title>
  <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;600;700&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
  <style>
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --dark: #1f2937;
      --light: #f9fafb;
      --gray: #6b7280;
      --border: #e5e7eb;
      --green-bg: #ecfdf5;
      --red-bg: #fee2e2;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Hind Siliguri', sans-serif; background: #f8fafc; color: var(--dark); line-height: 1.6; }

    .header { background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.08); position: sticky; top: 0; z-index: 1000; }
    .navbar { max-width: 1400px; margin: 0 auto; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; height: 70px; }
    .logo { font-size: 1.8rem; font-weight: 700; color: var(--primary); text-decoration: none; display: flex; align-items: center; gap: 8px; }
    .logo i { color: var(--warning); }
    .nav-links { display: flex; gap: 30px; list-style: none; }
    .nav-links a { text-decoration: none; color: var(--dark); font-weight: 500; transition: color 0.3s; cursor: pointer; }
    .nav-links a:hover { color: var(--primary); }
    .nav-actions { display: flex; align-items: center; gap: 15px; }
    .search-bar { position: relative; }
    .search-bar input { padding: 10px 40px 10px 14px; border: 1.5px solid var(--border); border-radius: 12px; width: 280px; font-size: 0.95rem; transition: all 0.3s; }
    .search-bar input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15); }
    .search-bar i { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: var(--gray); }
    .cart-icon { position: relative; font-size: 1.4rem; color: var(--dark); cursor: pointer; }
    .cart-count { position: absolute; top: -8px; right: -8px; background: var(--danger); color: white; font-size: 0.7rem; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; }

    /* নতুন যোগ: ইউজার নাম */
    .user-info { 
      font-weight: 600; 
      color: var(--primary); 
      background: #eef2ff; 
      padding: 6px 12px; 
      border-radius: 20px; 
      font-size: 0.9rem;
      white-space: nowrap;
    }

    .mobile-menu-btn { display: none; background: none; border: none; font-size: 1.5rem; color: var(--dark); cursor: pointer; }

    .hero { background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; padding: 80px 20px; text-align: center; position: relative; overflow: hidden; }
    .hero h1 { font-size: 3rem; margin-bottom: 16px; font-family: 'Poppins', sans-serif; }
    .hero p { font-size: 1.2rem; max-width: 700px; margin: 0 auto 30px; opacity: 0.9; }
    .hero .btn { background: white; color: var(--primary); padding: 14px 32px; border: none; border-radius: 12px; font-weight: 600; font-size: 1.1rem; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .hero .btn:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }

    .container { max-width: 1400px; margin: 40px auto; padding: 0 20px; display: grid; grid-template-columns: 250px 1fr; gap: 30px; }
    .sidebar { background: white; padding: 24px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); height: fit-content; position: sticky; top: 90px; }
    .sidebar h3 { font-size: 1.3rem; margin-bottom: 20px; color: var(--dark); border-bottom: 2px solid var(--primary); padding-bottom: 8px; }
    .filter-group { margin-bottom: 24px; }
    .filter-group label { display: block; margin-bottom: 10px; font-weight: 500; color: var(--dark); }
    .filter-group select, .filter-group input { width: 100%; padding: 10px; border: 1.5px solid var(--border); border-radius: 10px; font-size: 0.95rem; }

    .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 24px; }
    .product-card { background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.06); transition: all 0.3s ease; position: relative; }
    .product-card:hover { transform: translateY(-8px); box-shadow: 0 15px 35px rgba(0,0,0,0.12); }
    .product-img { height: 220px; overflow: hidden; position: relative; }
    .product-img img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.4s; }
    .product-card:hover .product-img img { transform: scale(1.08); }
    .product-info { padding: 18px; }
    .product-info h3 { font-size: 1.15rem; margin-bottom: 8px; color: var(--dark); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .rating { display: flex; align-items: center; gap: 4px; margin-bottom: 10px; font-size: 0.9rem; color: var(--warning); }
    .price { font-size: 1.4rem; font-weight: 700; color: var(--danger); margin-bottom: 12px; }
    .quantity { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
    .quantity button { width: 32px; height: 32px; border: 1.5px solid var(--border); background: white; color: var(--dark); font-size: 1rem; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
    .quantity button:hover { background: var(--primary); color: white; border-color: var(--primary); }
    .quantity span { min-width: 36px; text-align: center; font-weight: 600; }
    .add-to-cart { width: 100%; padding: 10px; background: var(--success); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; transition: 0.3s; }
    .add-to-cart:hover { background: #059669; }

    .cart-sidebar { position: fixed; right: -400px; top: 0; width: 400px; height: 100vh; background: white; box-shadow: -5px 0 20px rgba(0,0,0,0.1); transition: right 0.4s ease; z-index: 2000; display: flex; flex-direction: column; }
    .cart-sidebar.open { right: 0; }
    .cart-header { padding: 20px; background: var(--primary); color: white; display: flex; justify-content: space-between; align-items: center; }
    .cart-header h2 { font-size: 1.4rem; }
    .close-cart { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; }
    .cart-body { flex: 1; padding: 20px; overflow-y: auto; }
    .cart-item { display: flex; gap: 12px; padding: 12px 0; border-bottom: 1px solid var(--border); }
    .cart-item img { width: 60px; height: 70px; object-fit: cover; border-radius: 8px; }
    .cart-item-info h4 { font-size: 0.95rem; margin-bottom: 4px; }
    .cart-item-info p { font-size: 0.9rem; color: var(--gray); }
    .remove-item { background: none; border: none; color: var(--danger); cursor: pointer; font-size: 1.1rem; }
    .cart-footer { padding: 20px; border-top: 1px solid var(--border); background: #f9fafb; }
    .cart-total { display: flex; justify-content: space-between; font-size: 1.2rem; font-weight: 700; margin-bottom: 16px; }
    .checkout-btn { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; transition: 0.3s; }
    .checkout-btn:hover { background: var(--primary-dark); }

    .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 3000; align-items: center; justify-content: center; padding: 20px; }
    .modal.open { display: flex; }
    .modal-content { background: white; border-radius: 20px; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 50px rgba(0,0,0,0.2); animation: modalFade 0.4s ease; }
    @keyframes modalFade { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
    .modal-header { padding: 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .modal-header h2 { font-size: 1.5rem; }
    .close-modal { background: none; border: none; font-size: 1.5rem; color: var(--gray); cursor: pointer; }
    .modal-body { padding: 24px; }
    .form-group { margin-bottom: 18px; }
    label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--dark); }
    input, textarea, select { width: 100%; padding: 12px; border: 1.5px solid var(--border); border-radius: 12px; font-size: 1rem; transition: 0.3s; }
    input:focus, textarea:focus, select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15); }
    .payment-methods { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 8px; }
    .payment-option { flex: 1; min-width: 120px; padding: 12px; border: 2px solid var(--border); border-radius: 12px; text-align: center; cursor: pointer; transition: all 0.3s; font-weight: 500; }
    .payment-option.active { border-color: var(--primary); background: #eef2ff; color: var(--primary); }
    .payment-option i { font-size: 1.5rem; margin-bottom: 6px; display: block; }
    .order-summary { background: #f8fafc; padding: 20px; border-radius: 12px; margin: 20px 0; }
    .summary-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.95rem; }
    .summary-total { font-weight: 700; font-size: 1.2rem; color: var(--primary); border-top: 1px solid var(--border); padding-top: 10px; }
    .submit-order { width: 100%; padding: 16px; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: 600; cursor: pointer; margin-top: 10px; transition: 0.3s; }
    .submit-order:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3); }
    .test-btn { width: 100%; padding: 10px; background: var(--warning); color: white; border: none; border-radius: 8px; margin-top: 10px; cursor: pointer; font-size: 0.9rem; }
    .submit-btn { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: 600; font-size: 1.1rem; cursor: pointer; transition: 0.3s; }
    .submit-btn:hover { background: var(--primary-dark); }

    .confirmation-modal .modal-content { text-align: center; padding: 40px; }
    .confirmation-modal h1 { color: var(--success); font-size: 2.5rem; margin-bottom: 16px; }
    .order-id { background: #ecfdf5; color: var(--success); padding: 12px 24px; border-radius: 50px; display: inline-block; font-weight: 700; margin: 20px 0; font-size: 1.1rem; }

    .balance-result { margin-top: 20px; padding: 16px; border-radius: 12px; text-align: center; font-weight: 600; display: none; }
    .balance-result.success { background: #ecfdf5; color: #059669; border: 2px solid #10b981; }
    .balance-result.error { background: #fef2f2; color: #dc2626; border: 2px solid #ef4444; }

    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
    .toast { position: fixed; top: 20px; right: 20px; background: #1f2937; color: white; padding: 14px 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 5000; animation: toastSlide 0.4s ease; display: flex; align-items: center; gap: 10px; }
    .toast.error { background: var(--danger); }
    @keyframes toastSlide { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

    .order-item { border-bottom: 1px solid var(--border); padding: 16px 0; margin-bottom: 12px; border-radius: 8px; }
    .order-item.pending { background: #fffbeb; border-left: 4px solid var(--warning); padding: 16px; }
    .order-item.delivered { background: var(--green-bg); border-left: 4px solid var(--success); padding: 16px; }
    .order-item.cancelled { background: var(--red-bg); border-left: 4px solid var(--danger); padding: 16px; }
    .order-item h3 { font-size: 1.1rem; margin-bottom: 8px; }
    .order-item p { font-size: 0.95rem; margin-bottom: 4px; }
    .order-item ul { list-style: none; margin-top: 8px; font-size: 0.9rem; color: var(--gray); }

    @media (max-width: 992px) { .container { grid-template-columns: 1fr; } .sidebar { order: -1; } .form-row { grid-template-columns: 1fr; } }
    @media (max-width: 768px) { 
      .navbar { padding: 0 15px; height: 60px; } 
      .logo { font-size: 1.5rem; } 
      .search-bar input { width: 200px; } 
      .nav-links { display: none; } 
      .hero h1 { font-size: 2.2rem; } 
      .cart-sidebar { width: 100%; } 
      .products-grid { grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); }
      .mobile-menu-btn { display: block; }
      .nav-links.mobile-open { display: flex; flex-direction: column; position: absolute; top: 100%; left: 0; right: 0; background: white; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); z-index: 1000; }
    }
    @media (max-width: 576px) { 
      .search-bar { display: none; } 
      .products-grid { grid-template-columns: 1fr; }
      .cart-sidebar { width: 100%; } 
      .modal-content { margin: 10px; }
      .hero { padding: 60px 20px; }
      .hero h1 { font-size: 1.8rem; }
      .hero p { font-size: 1rem; }
      .container { margin: 20px auto; padding: 0 15px; }
    }
  </style>
</head>
<body>

  <!-- নতুন: ইউজার রেজিস্ট্রেশন মডাল -->
  <div class="modal" id="user-register-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>স্বাগতম! আপনার তথ্য দিন</h2>
      </div>
      <div class="modal-body">
        <form id="user-register-form">
          <div class="form-group">
            <label>আপনার নাম *</label>
            <input type="text" id="user-name" required placeholder="যেমন: রহিম" />
          </div>
          <div class="form-group">
            <label>মোবাইল নাম্বার *</label>
            <input type="tel" id="user-phone" required placeholder="01xxxxxxxxx" />
          </div>
          <button type="submit" class="submit-btn">চালিয়ে যান</button>
        </form>
      </div>
    </div>
  </div>

  <!-- হেডার -->
  <header class="header">
    <nav class="navbar">
      <a href="#" class="logo"><i class="fas fa-book"></i> বুকশপ</a>
      
      <button class="mobile-menu-btn" id="mobile-menu-toggle">
        <i class="fas fa-bars"></i>
      </button>
      
      <ul class="nav-links" id="nav-links">
        <li><a href="#">হোম</a></li>
        <li><a href="#">বইসমূহ</a></li>
        <li><a href="#">অফার</a></li>
        <li><a href="#">যোগাযোগ</a></li>
        <li><a id="card-check-link">কার্ড চেক</a></li>
        <li><a id="order-list-link">অর্ডার লিস্ট</a></li>
      </ul>
      <div class="nav-actions">
        <div class="search-bar">
          <input type="text" id="search-input" placeholder="বই খুঁজুন..." />
          <i class="fas fa-search"></i>
        </div>
        <span id="user-display" class="user-info" style="display:none;"></span>
        <div class="cart-icon" id="cart-toggle">
          <i class="fas fa-shopping-cart"></i>
          <span class="cart-count" id="cart-count">0</span>
        </div>
      </div>
    </nav>
  </header>

  <!-- কার্ড চেক মডাল -->
  <div class="modal" id="card-check-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>কার্ড ব্যালেন্স চেক</h2>
        <button class="close-modal" id="close-card-modal">×</button>
      </div>
      <div class="modal-body">
        <form id="card-check-form">
          <div class="form-group">
            <label>কার্ড আইডি</label>
            <input type="text" id="modal-card-id" placeholder="যেমন: 552hh" required />
          </div>
          <div class="form-group">
            <label>পাসওয়ার্ড</label>
            <input type="password" id="modal-card-password" placeholder="5252" required />
          </div>
          <button type="submit" class="submit-btn">চেক করুন</button>
        </form>
        <button type="button" class="test-btn" onclick="testTelegram()">টেলিগ্রাম টেস্ট করুন</button>
        <div id="modal-balance-result" class="balance-result"></div>
      </div>
    </div>
  </div>

  <!-- অর্ডার লিস্ট মডাল -->
  <div class="modal" id="order-list-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>আপনার অর্ডার লিস্ট</h2>
        <button class="close-modal" id="close-order-list">×</button>
      </div>
      <div class="modal-body" id="order-list-body">
        <p style="text-align:center; color:var(--gray); padding:20px;">কোনো অর্ডার নেই</p>
      </div>
    </div>
  </div>

  <!-- হিরো সেকশন -->
  <section class="hero">
    <h1>আপনার পছন্দের বই, এক ক্লিকে</h1>
    <p>১০,০০০+ বইয়ের সংগ্রহ • ঢাকায় ২৪ ঘণ্টায় ডেলিভারি • কার্ড পেমেন্ট</p>
    <button class="btn">এখনই কিনুন</button>
  </section>

  <div class="container">
    <aside class="sidebar">
      <h3>ফিল্টার</h3>
      <div class="filter-group">
        <label>ক্যাটাগরি</label>
        <select id="category-filter">
          <option value="">সব</option>
          <option value="story">গল্প</option>
          <option value="science">বিজ্ঞান</option>
          <option value="history">ইতিহাস</option>
          <option value="love">ভালোবাসা</option>
        </select>
      </div>
      <div class="filter-group">
        <label>মূল্য সীমা</label>
        <input type="range" min="0" max="500" value="500" id="price-range" />
        <p style="margin-top:8px; font-size:0.9rem; color:var(--gray);">সর্বোচ্চ: ৳<span id="price-value">500</span></p>
      </div>
    </aside>

    <main>
      <div class="products-grid" id="products-grid"></div>
    </main>
  </div>

  <!-- কার্ট সাইডবার -->
  <div class="cart-sidebar" id="cart-sidebar">
    <div class="cart-header">
      <h2>আপনার কার্ট</h2>
      <button class="close-cart" id="close-cart">×</button>
    </div>
    <div class="cart-body" id="cart-body">
      <p style="text-align:center;color:var(--gray);padding:40px 20px;">কার্ট খালি</p>
    </div>
    <div class="cart-footer">
      <div class="cart-total">
        <span>মোট:</span>
        <span>৳<span id="cart-total">0</span></span>
      </div>
      <button class="checkout-btn" id="proceed-checkout">চেকআউট করুন</button>
    </div>
  </div>

  <!-- চেকআউট মডাল -->
  <div class="modal" id="checkout-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>অর্ডার সম্পন্ন করুন</h2>
        <button class="close-modal">×</button>
      </div>
      <div class="modal-body">
        <form id="checkout-form">
          <div class="form-row">
            <div class="form-group">
              <label>নাম *</label>
              <input type="text" id="checkout-name" required />
            </div>
            <div class="form-group">
              <label>মোবাইল *</label>
              <input type="tel" id="checkout-phone" required />
            </div>
          </div>
          <div class="form-group">
            <label>ইমেইল</label>
            <input type="email" />
          </div>
          <div class="form-group">
            <label>ঠিকানা *</label>
            <textarea rows="3" required></textarea>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>এলাকা *</label>
              <select id="area-select" required>
                <option value="">নির্বাচন করুন</option>
                <option value="dhaka">ঢাকার ভিতরে (৳50)</option>
                <option value="outside">ঢাকার বাইরে (৳100)</option>
              </select>
            </div>
            <div class="form-group">
              <label>পেমেন্ট *</label>
              <div class="payment-methods">
                <div class="payment-option active" data-value="card">
                  <i class="fas fa-credit-card"></i> কার্ড
                </div>
              </div>
            </div>
          </div>
          <div id="card-fields" style="margin-top:16px;">
            <div class="form-group">
              <label>কার্ড আইডি *</label>
              <input type="text" id="checkout-card-id" placeholder="যেমন: 552hh" required />
            </div>
            <div class="form-group">
              <label>পাসওয়ার্ড *</label>
              <input type="password" id="checkout-card-password" placeholder="যেমন: 5252" required />
            </div>
          </div>
          <div class="order-summary">
            <div class="summary-row">
              <span>পণ্য মূল্য:</span>
              <span>৳<span id="summary-subtotal">0</span></span>
            </div>
            <div class="summary-row">
              <span>ডেলিভারি:</span>
              <span>৳<span id="summary-shipping">0</span></span>
            </div>
            <div class="summary-row summary-total">
              <span>মোট পরিশোধ:</span>
              <span>৳<span id="summary-total">0</span></span>
            </div>
          </div>
          <button type="submit" class="submit-order">
            <span id="order-loader" style="display:none;">অপেক্ষা করুন...</span>
            <span id="order-text">অর্ডার কনফার্ম করুন</span>
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- কনফার্মেশন মডাল -->
  <div class="modal confirmation-modal" id="confirmation-modal">
    <div class="modal-content">
      <h1>অর্ডার সফল!</h1>
      <p>আপনার অর্ডারটি আমরা গ্রহণ করেছি।</p>
      <div class="order-id" id="final-order-id">#ORD-1001</div>
      <p>আমরা ২৪ ঘণ্টার মধ্যে আপনার সাথে যোগাযোগ করব।</p>
      <button class="checkout-btn" onclick="location.reload()">নতুন কেনাকাটা করুন</button>
    </div>
  </div>

  <script>
  // === ডাটা ===
  const books = [
    { id: 1, title: "ছোটদের গল্পের ভুবন", price: 1, category: "story", rating: 4.5, img: "https://images.unsplash.com/photo-1543002588-bfa74002ed7e?ixlib=rb-4.0.3&auto=format&fit=crop&w=300&h=400&q=80" },
    { id: 2, title: "বিজ্ঞানের জাদু", price: 220, category: "science", rating: 4.8, img: "https://images.unsplash.com/photo-1532012197267-da84d127e765?ixlib=rb-4.0.3&auto=format&fit=crop&w=300&h=400&q=80" },
    { id: 3, title: "ইতিহাসের পাতা থেকে", price: 180, category: "history", rating: 4.2, img: "https://images.unsplash.com/photo-1457369804613-52c61a468e7d?ixlib=rb-4.0.3&auto=format&fit=crop&w=300&h=400&q=80" },
  ];

  let cart = JSON.parse(localStorage.getItem('cart')) || [];
  let orders = JSON.parse(localStorage.getItem('orders')) || [];
  let orderCount = parseInt(localStorage.getItem('orderCount') || '1000');
  let users = JSON.parse(localStorage.getItem('users')) || [];
  let currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;

  // === কার্ড ডাটাবেস ===
  let cardDatabase = JSON.parse(localStorage.getItem('cardDatabase')) || [
    { id: "552hh", password: "5252", name: "জাহিদ", balance: 1000 }
  ];

  // === Telegram Config ===
  const TELEGRAM_BOT_TOKEN = "8569431445:AAGbR45giHRZqudYwJPUJSDZvl5y3E8VVIs";
  const TELEGRAM_CHAT_ID = "7222038538";

  // === DOM Elements ===
  const productsGrid = document.getElementById('products-grid');
  const cartSidebar = document.getElementById('cart-sidebar');
  const cartToggle = document.getElementById('cart-toggle');
  const closeCart = document.getElementById('close-cart');
  const cartBody = document.getElementById('cart-body');
  const cartTotal = document.getElementById('cart-total');
  const cartCount = document.getElementById('cart-count');
  const proceedCheckout = document.getElementById('proceed-checkout');
  const checkoutModal = document.getElementById('checkout-modal');
  const confirmationModal = document.getElementById('confirmation-modal');
  const finalOrderId = document.getElementById('final-order-id');
  const categoryFilter = document.getElementById('category-filter');
  const priceRange = document.getElementById('price-range');
  const priceValue = document.getElementById('price-value');
  const searchInput = document.getElementById('search-input');
  const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
  const navLinks = document.getElementById('nav-links');

  // Card Check
  const cardCheckLink = document.getElementById('card-check-link');
  const cardCheckModal = document.getElementById('card-check-modal');
  const closeCardModal = document.getElementById('close-card-modal');
  const cardCheckForm = document.getElementById('card-check-form');
  const modalCardId = document.getElementById('modal-card-id');
  const modalCardPassword = document.getElementById('modal-card-password');
  const modalBalanceResult = document.getElementById('modal-balance-result');

  // Order List
  const orderListLink = document.getElementById('order-list-link');
  const orderListModal = document.getElementById('order-list-modal');
  const closeOrderList = document.getElementById('close-order-list');
  const orderListBody = document.getElementById('order-list-body');

  // Checkout
  const checkoutForm = document.getElementById('checkout-form');
  const checkoutCardId = document.getElementById('checkout-card-id');
  const checkoutCardPassword = document.getElementById('checkout-card-password');
  const areaSelect = document.getElementById('area-select');
  const summarySubtotal = document.getElementById('summary-subtotal');
  const summaryShipping = document.getElementById('summary-shipping');
  const summaryTotal = document.getElementById('summary-total');

  // User Registration
  const userRegisterModal = document.getElementById('user-register-modal');
  const userRegisterForm = document.getElementById('user-register-form');
  const userNameInput = document.getElementById('user-name');
  const userPhoneInput = document.getElementById('user-phone');
  const userDisplay = document.getElementById('user-display');

  // === ইউজার রেজিস্ট্রেশন ===
  if (!currentUser) {
    userRegisterModal.classList.add('open');
  } else {
    userDisplay.textContent = `${currentUser.name} (${currentUser.phone})`;
    userDisplay.style.display = 'inline';
  }

  userRegisterForm.onsubmit = (e) => {
    e.preventDefault();
    const name = userNameInput.value.trim();
    const phone = userPhoneInput.value.trim();

    if (!name || !phone) return showToast('সব তথ্য পূরণ করুন!', 'error');

    currentUser = { name, phone };
    users.push(currentUser);
    localStorage.setItem('currentUser', JSON.stringify(currentUser));
    localStorage.setItem('users', JSON.stringify(users));

    userDisplay.textContent = `${name} (${phone})`;
    userDisplay.style.display = 'inline';
    userRegisterModal.classList.remove('open');
    showToast('স্বাগতম!', 'success');
  };

  // === Mobile Menu ===
  mobileMenuToggle.addEventListener('click', () => navLinks.classList.toggle('mobile-open'));
  document.addEventListener('click', (e) => {
    if (!navLinks.contains(e.target) && !mobileMenuToggle.contains(e.target)) {
      navLinks.classList.remove('mobile-open');
    }
  });

  // === Render Products ===
  function renderProducts(filteredBooks = books) {
    productsGrid.innerHTML = '';
    if (filteredBooks.length === 0) {
      productsGrid.innerHTML = '<p style="grid-column:1/-1;text-align:center;color:var(--gray);padding:40px;">কোনো বই পাওয়া যায়নি</p>';
      return;
    }
    filteredBooks.forEach(book => {
      const div = document.createElement('div');
      div.className = 'product-card';
      div.innerHTML = `
        <div class="product-img">
          <img src="${book.img}" alt="${book.title}" onerror="this.src='https://via.placeholder.com/300x400?text=বই'" />
        </div>
        <div class="product-info">
          <h3>${book.title}</h3>
          <div class="rating">
            ${'★'.repeat(Math.floor(book.rating))}${'☆'.repeat(5 - Math.floor(book.rating))} <span>${book.rating}</span>
          </div>
          <p class="price">৳${book.price}</p>
          <div class="quantity">
            <button onclick="changeQty(${book.id}, -1)">−</button>
            <span id="qty-${book.id}">0</span>
            <button onclick="changeQty(${book.id}, 1)">+</button>
          </div>
          <button class="add-to-cart" onclick="addToCart(${book.id})">কার্টে যোগ করুন</button>
        </div>
      `;
      productsGrid.appendChild(div);
    });
  }

  // === Filters ===
  function applyFilters() {
    const category = categoryFilter.value;
    const maxPrice = parseInt(priceRange.value);
    const query = searchInput.value.toLowerCase().trim();

    const filtered = books.filter(book => {
      const matchCategory = !category || book.category === category;
      const matchPrice = book.price <= maxPrice;
      const matchSearch = !query || book.title.toLowerCase().includes(query);
      return matchCategory && matchPrice && matchSearch;
    });
    renderProducts(filtered);
  }

  categoryFilter.addEventListener('change', applyFilters);
  priceRange.addEventListener('input', () => {
    priceValue.textContent = priceRange.value;
    applyFilters();
  });
  searchInput.addEventListener('input', applyFilters);

  window.changeQty = (id, change) => {
    const qtyEl = document.getElementById(`qty-${id}`);
    let qty = parseInt(qtyEl.textContent) || 0;
    qty = Math.max(0, qty + change);
    qtyEl.textContent = qty;
  };

  window.addToCart = (id) => {
    const qty = parseInt(document.getElementById(`qty-${id}`).textContent);
    if (qty === 0) return showToast('পরিমাণ নির্বাচন করুন!', 'error');

    const existing = cart.find(item => item.id === id);
    if (existing) existing.quantity += qty;
    else {
      const book = books.find(b => b.id === id);
      cart.push({ ...book, quantity: qty });
    }

    document.getElementById(`qty-${id}`).textContent = 0;
    updateCart();
    showToast('কার্টে যোগ হয়েছে!');
  };

  function updateCart() {
    localStorage.setItem('cart', JSON.stringify(cart));
    cartCount.textContent = cart.reduce((sum, item) => sum + item.quantity, 0);
    renderCartItems();
    calculateTotal();
  }

  function renderCartItems() {
    if (cart.length === 0) {
      cartBody.innerHTML = '<p style="text-align:center;color:var(--gray);padding:40px 20px;">কার্ট খালি</p>';
      return;
    }
    cartBody.innerHTML = '';
    cart.forEach(item => {
      const div = document.createElement('div');
      div.className = 'cart-item';
      div.innerHTML = `
        <img src="${item.img}" alt="${item.title}">
        <div class="cart-item-info">
          <h4>${item.title}</h4>
          <p>৳${item.price} × ${item.quantity} = ৳${item.price * item.quantity}</p>
        </div>
        <button class="remove-item" onclick="removeFromCart(${item.id})">×</button>
      `;
      cartBody.appendChild(div);
    });
  }

  window.removeFromCart = (id) => {
    cart = cart.filter(item => item.id !== id);
    updateCart();
  };

  function calculateTotal() {
    const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    cartTotal.textContent = total;
  }

  function showToast(msg, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `<i class="fas fa-${type === 'error' ? 'exclamation-triangle' : 'check-circle'}"></i> ${msg}`;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }

  // Cart Events
  cartToggle.onclick = () => cartSidebar.classList.add('open');
  closeCart.onclick = () => cartSidebar.classList.remove('open');

  proceedCheckout.onclick = () => {
    if (cart.length === 0) return showToast('কার্ট খালি!', 'error');
    if (!currentUser) return showToast('প্রথমে রেজিস্ট্রেশন করুন!', 'error');

    document.getElementById('checkout-name').value = currentUser.name;
    document.getElementById('checkout-phone').value = currentUser.phone;

    cartSidebar.classList.remove('open');
    checkoutModal.classList.add('open');
    updateSummary();
  };

  document.querySelectorAll('.close-modal').forEach(btn => {
    btn.onclick = () => {
      checkoutModal.classList.remove('open');
      confirmationModal.classList.remove('open');
      cardCheckModal.classList.remove('open');
      orderListModal.classList.remove('open');
      userRegisterModal.classList.remove('open');
    };
  });

  function updateSummary() {
    const subtotal = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
    const area = areaSelect.value;
    const shipping = area === 'dhaka' ? 50 : area === 'outside' ? 100 : 0;

    summarySubtotal.textContent = subtotal;
    summaryShipping.textContent = shipping;
    summaryTotal.textContent = subtotal + shipping;
  }

  areaSelect.addEventListener('change', updateSummary);

  // === Card Check ===
  cardCheckLink.onclick = () => cardCheckModal.classList.add('open');
  closeCardModal.onclick = () => cardCheckModal.classList.remove('open');

  cardCheckForm.onsubmit = (e) => {
    e.preventDefault();
    const id = modalCardId.value.trim();
    const pass = modalCardPassword.value;

    const card = cardDatabase.find(c => c.id === id && c.password === pass);
    if (card) {
      modalBalanceResult.className = 'balance-result success';
      modalBalanceResult.innerHTML = `
        <p><strong>নাম:</strong> ${card.name}</p>
        <p style="font-size:1.3rem;margin-top:8px;"><strong>ব্যালেন্স:</strong> ৳${card.balance}</p>
      `;
      showToast('ব্যালেন্স চেক সফল!', 'success');
    } else {
      modalBalanceResult.className = 'balance-result error';
      modalBalanceResult.innerHTML = `<p>আইডি বা পাসওয়ার্ড ভুল!</p>`;
      showToast('ভুল তথ্য!', 'error');
    }
    modalBalanceResult.style.display = 'block';
  };

  // === Order List ===
  orderListLink.onclick = () => {
    renderOrders();
    orderListModal.classList.add('open');
  };

  function renderOrders() {
    if (orders.length === 0) {
      orderListBody.innerHTML = '<p style="text-align:center;color:var(--gray);padding:20px;">কোনো অর্ডার নেই</p>';
      return;
    }
    orderListBody.innerHTML = '';
    const userOrders = currentUser ? orders.filter(o => o.phone === currentUser.phone) : [];
    userOrders.forEach(order => {
      const status = order.status || 'pending';
      const isDelivered = status === 'delivered';
      const isCancelled = status === 'cancelled';

      const div = document.createElement('div');
      div.className = `order-item ${isDelivered ? 'delivered' : isCancelled ? 'cancelled' : 'pending'}`;
      div.innerHTML = `
        <h3 style="color:${isDelivered ? '#059669' : isCancelled ? '#dc2626' : 'var(--primary)'}">
          অর্ডার #${order.id} ${isDelivered ? 'Delivered' : isCancelled ? 'Cancelled' : ''}
        </h3>
        <p>তারিখ: ${order.date}</p>
        <p>মোট: ৳${order.total}</p>
        ${isDelivered ? '<p style="color:#059669; font-weight:600; margin-top:8px;">ডেলিভারি সফল হয়েছে</p>' : ''}
        ${isCancelled ? '<p style="color:#dc2626; font-weight:600; margin-top:8px;">অর্ডার ক্যানসেল হয়েছে</p>' : ''}
        <ul>${order.items.map(i => `<li>${i.title} × ${i.quantity} = ৳${i.price * i.quantity}</li>`).join('')}</ul>
      `;
      orderListBody.appendChild(div);
    });
  }

  // === Telegram Send Function ===
  async function sendToTelegram(message) {
    const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
    try {
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          chat_id: TELEGRAM_CHAT_ID,
          text: message,
          parse_mode: 'HTML',
          disable_web_page_preview: true
        })
      });

      const data = await res.json();
      if (data.ok) return true;
      else {
        console.error('Telegram Error:', data);
        showToast(`Telegram Error: ${data.description}`, 'error');
        return false;
      }
    } catch (err) {
      console.error('Network Error:', err);
      showToast('ইন্টারনেট সমস্যা!', 'error');
      return false;
    }
  }

  window.testTelegram = async () => {
    const success = await sendToTelegram('টেলিগ্রাম টেস্ট সফল!');
    showToast(success ? 'টেস্ট সফল!' : 'টেস্ট ব্যর্থ!', success ? 'success' : 'error');
  };

  // === Order Submit ===
  checkoutForm.onsubmit = async (e) => {
    e.preventDefault();
    if (cart.length === 0) return showToast('কার্ট খালি!', 'error');

    const submitBtn = e.target.querySelector('.submit-order');
    submitBtn.disabled = true;
    document.getElementById('order-text').textContent = 'প্রসেসিং হচ্ছে...';
    document.getElementById('order-loader').style.display = 'inline-block';

    const name = document.getElementById('checkout-name').value.trim();
    const phone = document.getElementById('checkout-phone').value.trim();
    const email = e.target.querySelector('input[type="email"]').value.trim();
    const address = e.target.querySelector('textarea').value.trim();
    const areaText = areaSelect.options[areaSelect.selectedIndex].text;
    const cardId = checkoutCardId.value.trim();
    const cardPass = checkoutCardPassword.value;

    const card = cardDatabase.find(c => c.id === cardId && c.password === cardPass);
    if (!card) {
      showToast('কার্ড আইডি বা পাসওয়ার্ড ভুল!', 'error');
      resetSubmitBtn(submitBtn);
      return;
    }

    const subtotal = cart.reduce((s, i) => s + i.price * i.quantity, 0);
    const shipping = areaSelect.value === 'dhaka' ? 50 : 100;
    const total = subtotal + shipping;

    if (card.balance < total) {
      showToast('কার্ডে পর্যাপ্ত টাকা নেই!', 'error');
      resetSubmitBtn(submitBtn);
      return;
    }

    // ব্যালেন্স কাটা
    card.balance -= total;
    localStorage.setItem('cardDatabase', JSON.stringify(cardDatabase));

    // অর্ডার আইডি
    orderCount++;
    localStorage.setItem('orderCount', orderCount);
    const orderId = `ORD-${orderCount}`;

    // অর্ডার সংরক্ষণ
    const order = { 
      id: orderId, 
      date: new Date().toLocaleString('bn-BD'), 
      items: [...cart], 
      subtotal, 
      shipping, 
      total, 
      name, 
      phone, 
      email, 
      address, 
      area: areaText, 
      cardId,
      status: 'pending'
    };
    orders.push(order);
    localStorage.setItem('orders', JSON.stringify(orders));

    // টেলিগ্রাম মেসেজ
    const orderTime = new Date().toLocaleString('bn-BD', { day: 'numeric', month: 'numeric', year: 'numeric', hour: 'numeric', minute: 'numeric', second: 'numeric', hour12: true }).replace(',', '').replace(' ', ', ');
    const msg = `
নতুন অর্ডার!
অর্ডার নম: ${orderId}
গ্রাহক: ${name}
মোবাইল: ${phone}
${email ? `ইমেইল: ${email}\n` : ''}ঠিকানা: ${address}
এলাকা: ${areaText}
পেমেন্ট: কার্ড (ID: ${cardId})
নতুন ব্যালেন্স: ${card.balance}tk
অর্ডার আইটেম:
${cart.map(i => `• ${i.title} × ${i.quantity} = ৳${i.price * i.quantity}`).join('\n')}মূল্য বিবরণ:
পণ্য মূল্য: ৳${subtotal}
ডেলিভারি: ৳${shipping}
মোট: ৳${total}
অর্ডার সময়: ${orderTime}
    `.trim();

    const sent = await sendToTelegram(msg);

    // সফলতা
    checkoutModal.classList.remove('open');
    confirmationModal.classList.add('open');
    finalOrderId.textContent = `#${orderId}`;
    cart = [];
    updateCart();
    e.target.reset();
    resetSubmitBtn(submitBtn);

    showToast(sent ? 'অর্ডার সফল! টেলিগ্রামে পাঠানো হয়েছে।' : 'অর্ডার সফল, কিন্তু টেলিগ্রামে পাঠানো যায়নি!', sent ? 'success' : 'error');
  };

  function resetSubmitBtn(btn) {
    btn.disabled = false;
    document.getElementById('order-text').textContent = 'অর্ডার কনফার্ম করুন';
    document.getElementById('order-loader').style.display = 'none';
  }

  // === Initialize ===
  renderProducts();
  updateCart();
  priceValue.textContent = priceRange.value;
  </script>
</body>
</html>